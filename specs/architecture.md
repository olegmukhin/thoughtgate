# ThoughtGate Architecture

| Metadata | Value |
|----------|-------|
| **Title** | System Architecture & Integration |
| **Status** | Draft |
| **Version** | v0.1 |
| **Tags** | `#architecture` `#integration` `#overview` `#mcp` `#hitl` |

## 1. Purpose

This document provides the **top-level architectural view** of ThoughtGate, showing how individual requirements compose into a coherent system. It serves as:

- Single source of truth for request lifecycle
- Integration guide for component interaction
- Configuration reference
- v0.1 scope definition

**Target deployment:** Kubernetes sidecar (co-located with AI agent in same pod).

## 2. System Overview

### 2.1 What is ThoughtGate?

ThoughtGate is an **MCP (Model Context Protocol) sidecar proxy** that implements **approval workflows** for AI agent tool calls. It intercepts MCP `tools/call` requests, classifies them via Cedar policies, and routes dangerous operations through human or agent approval before execution.

### 2.2 Core Value Proposition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WITHOUT ThoughtGate                             â”‚
â”‚                                                                         â”‚
â”‚   Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ MCP Server  â”‚
â”‚          "delete_user(id=12345)"                           (executes!)  â”‚
â”‚                                                                         â”‚
â”‚   Problem: Agent autonomously executes dangerous operations             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          WITH ThoughtGate                               â”‚
â”‚                                                                         â”‚
â”‚   Agent â”€â”€â”€â–¶ ThoughtGate â”€â”€â”€â–¶ Approver â”€â”€â”€â–¶ ThoughtGate â”€â”€â”€â–¶ MCP Serverâ”‚
â”‚              (intercepts)     (approves)    (executes)                  â”‚
â”‚                                                                         â”‚
â”‚   Benefit: Dangerous operations require approval                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Key Capabilities

| Capability | Description | Requirement |
|------------|-------------|-------------|
| **Policy-Based Classification** | Cedar policies classify tool calls into Green/Amber/Approval/Red paths | REQ-POL-001 |
| **Zero-Copy Streaming** | LLM token streams pass through without buffering | REQ-CORE-001 |
| **Request Inspection** | Buffer and inspect/transform requests before forwarding | REQ-CORE-002 |
| **Approval Workflows** | Human/agent approval via Slack (extensible to A2A, webhooks) | REQ-GOV-001/002/003 |
| **SEP-1686 Tasks** | Async task semantics for long-running approvals | REQ-GOV-001 |

## 3. Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ThoughtGate Sidecar                                â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     REQ-CORE-003: MCP Transport                         â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚   â”‚  HTTP+SSE   â”‚    â”‚  JSON-RPC   â”‚    â”‚    Method Router        â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  Listener   â”‚â”€â”€â”€â–¶â”‚   Parser    â”‚â”€â”€â”€â–¶â”‚                         â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  (Port 8080)â”‚    â”‚             â”‚    â”‚  tools/call â†’ Policy    â”‚    â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  tasks/*    â†’ TaskMgr   â”‚    â”‚   â”‚
â”‚  â”‚                                         â”‚  other      â†’ Upstream  â”‚    â”‚   â”‚
â”‚  â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                        â”‚                       â”‚
â”‚                                                        â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     REQ-POL-001: Cedar Policy Engine                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚   â”‚   Policy    â”‚    â”‚   Schema    â”‚    â”‚      Evaluator          â”‚    â”‚   â”‚
â”‚  â”‚   â”‚   Loader    â”‚â”€â”€â”€â–¶â”‚  Validator  â”‚â”€â”€â”€â–¶â”‚                         â”‚    â”‚   â”‚
â”‚  â”‚   â”‚             â”‚    â”‚             â”‚    â”‚  StreamRaw? â†’ Green     â”‚    â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  Inspect?   â†’ Amber     â”‚    â”‚   â”‚
â”‚  â”‚         â–²                               â”‚  Approve?   â†’ Approval      â”‚    â”‚   â”‚
â”‚  â”‚         â”‚                               â”‚  (none)     â†’ Red       â”‚    â”‚   â”‚
â”‚  â”‚   ConfigMap/Env                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                        â”‚                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚            â”‚                                           â”‚                   â”‚   â”‚
â”‚            â–¼                                           â–¼                   â–¼   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  REQ-CORE-001   â”‚                      â”‚  REQ-CORE-002   â”‚    â”‚REQ-CORE-04â”‚â”‚
â”‚  â”‚   Green Path    â”‚                      â”‚   Amber Path    â”‚    â”‚  Red Path â”‚â”‚
â”‚  â”‚                 â”‚                      â”‚                 â”‚    â”‚           â”‚â”‚
â”‚  â”‚  Zero-copy      â”‚                      â”‚  Buffer +       â”‚    â”‚  Return   â”‚â”‚
â”‚  â”‚  streaming      â”‚                      â”‚  Inspect        â”‚    â”‚  Error    â”‚â”‚
â”‚  â”‚                 â”‚                      â”‚                 â”‚    â”‚           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                                        â”‚                          â”‚
â”‚           â”‚                                        â–¼                          â”‚
â”‚           â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚           â”‚                      â”‚         REQ-GOV-001/002/003             â”‚  â”‚
â”‚           â”‚                      â”‚            Approval Path                    â”‚  â”‚
â”‚           â”‚                      â”‚                                         â”‚  â”‚
â”‚           â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚           â”‚                      â”‚  â”‚   Task    â”‚  â”‚    Approval       â”‚  â”‚  â”‚
â”‚           â”‚                      â”‚  â”‚  Manager  â”‚â—€â”€â”‚    Service        â”‚  â”‚  â”‚
â”‚           â”‚                      â”‚  â”‚ (SEP-1686)â”‚  â”‚  (Slack Webhook)  â”‚  â”‚  â”‚
â”‚           â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚           â”‚                      â”‚        â”‚                  â”‚            â”‚  â”‚
â”‚           â”‚                      â”‚        â–¼                  â”‚            â”‚  â”‚
â”‚           â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚            â”‚  â”‚
â”‚           â”‚                      â”‚  â”‚ Execution â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚           â”‚                      â”‚  â”‚ Pipeline  â”‚  (on approval)          â”‚  â”‚
â”‚           â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚           â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                               â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                           â”‚                               â”‚   â”‚
â”‚                                           â–¼                               â–¼   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        Upstream MCP Client                              â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚                    Forward to MCP Server (tools)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   MCP Server    â”‚
                              â”‚   (Upstream)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. Request Lifecycle

### 4.1 Complete Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           REQUEST LIFECYCLE                                     â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”                                                                       â”‚
â”‚   â”‚STARTâ”‚                                                                       â”‚
â”‚   â””â”€â”€â”¬â”€â”€â”˜                                                                       â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â–¼                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 1. RECEIVE (REQ-CORE-003)                                               â”‚  â”‚
â”‚   â”‚    â€¢ Accept HTTP POST on :8080                                          â”‚  â”‚
â”‚   â”‚    â€¢ Parse JSON-RPC 2.0                                                 â”‚  â”‚
â”‚   â”‚    â€¢ Extract method, params, id                                         â”‚  â”‚
â”‚   â”‚    â€¢ Detect SEP-1686 task metadata                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚                                        â”‚
â”‚                                       â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 2. ROUTE (REQ-CORE-003)                                                 â”‚  â”‚
â”‚   â”‚    â€¢ tools/call      â†’ Policy Engine                                    â”‚  â”‚
â”‚   â”‚    â€¢ tasks/*         â†’ Task Manager (SEP-1686)                          â”‚  â”‚
â”‚   â”‚    â€¢ resources/*     â†’ Policy Engine                                    â”‚  â”‚
â”‚   â”‚    â€¢ prompts/*       â†’ Policy Engine                                    â”‚  â”‚
â”‚   â”‚    â€¢ other           â†’ Direct to Upstream                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚                                        â”‚
â”‚                                       â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 3. CLASSIFY (REQ-POL-001)                                               â”‚  â”‚
â”‚   â”‚    â€¢ Build Cedar request (principal, resource, action)                  â”‚  â”‚
â”‚   â”‚    â€¢ Evaluate policies in order: StreamRaw â†’ Inspect â†’ Approve          â”‚  â”‚
â”‚   â”‚    â€¢ Return decision: Green / Amber / Approval / Red                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚                                        â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚               â”‚                       â”‚                       â”‚                â”‚
â”‚               â–¼                       â–¼                       â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ 4a. GREEN PATH    â”‚   â”‚ 4b. AMBER PATH    â”‚   â”‚ 4c. Approval PATH     â”‚       â”‚
â”‚   â”‚ (REQ-CORE-001)    â”‚   â”‚ (REQ-CORE-002)    â”‚   â”‚ (REQ-GOV-*)       â”‚       â”‚
â”‚   â”‚                   â”‚   â”‚                   â”‚   â”‚                   â”‚       â”‚
â”‚   â”‚ â€¢ Stream response â”‚   â”‚ â€¢ Buffer request  â”‚   â”‚ â€¢ Pre-Approval  â”‚       â”‚
â”‚   â”‚ â€¢ Zero-copy       â”‚   â”‚ â€¢ Run inspectors  â”‚   â”‚ â€¢ Create Task     â”‚       â”‚
â”‚   â”‚ â€¢ No buffering    â”‚   â”‚ â€¢ Transform/PII   â”‚   â”‚ â€¢ Send Webhook    â”‚       â”‚
â”‚   â”‚                   â”‚   â”‚ â€¢ Forward         â”‚   â”‚ â€¢ Wait for Human  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â€¢ On Approve:     â”‚       â”‚
â”‚             â”‚                       â”‚             â”‚   - Re-eval policyâ”‚       â”‚
â”‚             â”‚                       â”‚             â”‚   - Post-Approval     â”‚       â”‚
â”‚             â”‚                       â”‚             â”‚   - Forward       â”‚       â”‚
â”‚             â”‚                       â”‚             â”‚ â€¢ Store Result    â”‚       â”‚
â”‚             â”‚                       â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚             â”‚                       â”‚                       â”‚                  â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                     â”‚                                          â”‚
â”‚                                     â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5. RESPOND (REQ-CORE-003)                                               â”‚  â”‚
â”‚   â”‚    â€¢ Green/Amber: Return upstream response                              â”‚  â”‚
â”‚   â”‚    â€¢ Approval: Return SEP-1686 task token (agent polls)                     â”‚  â”‚
â”‚   â”‚    â€¢ Red: Return JSON-RPC error (REQ-CORE-004)                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚                                        â”‚
â”‚                                       â–¼                                        â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”                                      â”‚
â”‚                                   â”‚ END â”‚                                      â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 4d. RED PATH (REQ-CORE-004)                                             â”‚  â”‚
â”‚   â”‚    â€¢ Return JSON-RPC error                                              â”‚  â”‚
â”‚   â”‚    â€¢ Error code: -32003 (Policy Denied)                                 â”‚  â”‚
â”‚   â”‚    â€¢ Log audit event                                                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Approval Task Flow (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Approval TASK LIFECYCLE                                   â”‚
â”‚                                                                                 â”‚
â”‚   Agent                    ThoughtGate                    Human (Slack)         â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚  tools/call               â”‚                              â”‚                â”‚
â”‚     â”‚  {task:{ttl:600000}}      â”‚                              â”‚                â”‚
â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                       â”‚                â”‚
â”‚     â”‚                    â”‚ Pre-Approval    â”‚                       â”‚                â”‚
â”‚     â”‚                    â”‚ Amber       â”‚                       â”‚                â”‚
â”‚     â”‚                    â”‚ (inspect)   â”‚                       â”‚                â”‚
â”‚     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                       â”‚                â”‚
â”‚     â”‚                    â”‚ Create Task â”‚                       â”‚                â”‚
â”‚     â”‚                    â”‚ (SEP-1686)  â”‚                       â”‚                â”‚
â”‚     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚  {taskId, status:working} â”‚      Webhook                 â”‚                â”‚
â”‚     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
â”‚     â”‚                           â”‚      (approval request)      â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚  tasks/get                â”‚                              â”‚                â”‚
â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚  {status:input_required}  â”‚                              â”‚                â”‚
â”‚     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚        (polling)          â”‚         (human reviews)      â”‚                â”‚
â”‚     â”‚          ...              â”‚              ...             â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚                           â”‚      Callback                â”‚                â”‚
â”‚     â”‚                           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
â”‚     â”‚                           â”‚      {decision: approved}    â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                       â”‚                â”‚
â”‚     â”‚                    â”‚ Re-evaluate â”‚                       â”‚                â”‚
â”‚     â”‚                    â”‚ Policy      â”‚                       â”‚                â”‚
â”‚     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                       â”‚                â”‚
â”‚     â”‚                    â”‚ Post-Approval   â”‚                       â”‚                â”‚
â”‚     â”‚                    â”‚ Amber       â”‚                       â”‚                â”‚
â”‚     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                       â”‚                â”‚
â”‚     â”‚                    â”‚ Forward to  â”‚                       â”‚                â”‚
â”‚     â”‚                    â”‚ Upstream    â”‚                       â”‚                â”‚
â”‚     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚  tasks/result             â”‚                              â”‚                â”‚
â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â”‚  {result: ...}            â”‚                              â”‚                â”‚
â”‚     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚                â”‚
â”‚     â”‚                           â”‚                              â”‚                â”‚
â”‚     â–¼                           â–¼                              â–¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. Component Integration Matrix

### 5.1 Requirement Dependencies

| Requirement | Depends On | Provides To |
|-------------|------------|-------------|
| REQ-CORE-001 (Green Path) | â€” | REQ-CORE-003 |
| REQ-CORE-002 (Amber Path) | â€” | REQ-CORE-003, REQ-GOV-002 |
| REQ-CORE-003 (MCP Transport) | REQ-POL-001 | All paths |
| REQ-CORE-004 (Error Handling) | â€” | All |
| REQ-CORE-005 (Lifecycle) | â€” | All |
| REQ-POL-001 (Cedar Policy) | â€” | REQ-CORE-003, REQ-GOV-002 |
| REQ-GOV-001 (Task Lifecycle) | REQ-CORE-003 | REQ-GOV-002, REQ-GOV-003 |
| REQ-GOV-002 (Execution Pipeline) | REQ-CORE-002, REQ-POL-001, REQ-GOV-001 | REQ-GOV-003 |
| REQ-GOV-003 (Approval Integration) | REQ-GOV-001, REQ-GOV-002 | External systems |

### 5.2 Data Flow Between Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            DATA FLOW                                            â”‚
â”‚                                                                                 â”‚
â”‚   REQ-CORE-003         REQ-POL-001          REQ-CORE-001/002                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚   McpRequest    â”€â”€â”€â”€â”€â”€â–¶ PolicyRequest â”€â”€â”€â”€â”€â”€â–¶ PolicyDecision                   â”‚
â”‚   {method,              {principal,           {Green|Amber|                    â”‚
â”‚    params,               resource,             Approval|Red}                       â”‚
â”‚    id}                   action}                                               â”‚
â”‚                                                    â”‚                           â”‚
â”‚                                                    â–¼                           â”‚
â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                           â”‚ If Approval:      â”‚                    â”‚
â”‚                                           â”‚               â”‚                    â”‚
â”‚   REQ-GOV-001          REQ-GOV-002       â”‚  REQ-GOV-003  â”‚                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                    â”‚
â”‚   Task          â—€â”€â”€â”€â”€â”€ PreApprovalResult     â”‚               â”‚                    â”‚
â”‚   {id,                  {transformed,    â”‚  Webhook â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ External        â”‚
â”‚    status,               hash}           â”‚               â”‚                    â”‚
â”‚    request,                              â”‚  Callback â—€â”€â”€â”€â”¼â”€â”€â”€ External        â”‚
â”‚    approval}                             â”‚               â”‚                    â”‚
â”‚        â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚        â”‚                                                                       â”‚
â”‚        â–¼                                                                       â”‚
â”‚   REQ-GOV-002                                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚   PipelineResult                                                               â”‚
â”‚   {Success|Failure}                                                            â”‚
â”‚        â”‚                                                                       â”‚
â”‚        â–¼                                                                       â”‚
â”‚   REQ-CORE-003                                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚   McpResponse                                                                  â”‚
â”‚   {result|error}                                                               â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Interface Contracts Summary

| From | To | Interface | Data |
|------|-----|-----------|------|
| CORE-003 | POL-001 | `PolicyEngine::evaluate()` | `PolicyRequest` â†’ `PolicyDecision` |
| CORE-003 | GOV-001 | `TaskManager::handle()` | SEP-1686 methods |
| POL-001 | CORE-001 | Decision routing | `PolicyDecision::Green` |
| POL-001 | CORE-002 | Decision routing | `PolicyDecision::Amber` |
| POL-001 | GOV-001 | Decision routing | `PolicyDecision::Approval` |
| POL-001 | CORE-004 | Decision routing | `PolicyDecision::Red` |
| GOV-001 | GOV-002 | `ExecutionPipeline::execute_approved()` | `Task`, `ApprovalRecord` |
| GOV-002 | POL-001 | `PolicyEngine::evaluate()` (re-eval) | `PolicyRequest` + `ApprovalGrant` |
| GOV-002 | CORE-002 | Inspector chain | `InspectorDecision` |
| GOV-003 | GOV-001 | `TaskManager::record_approval()` | `ApprovalCallback` |
| GOV-003 | External | Webhook | `ApprovalWebhook` |
| External | GOV-003 | Callback | `ApprovalCallback` |

## 6. Configuration Reference

### 6.1 Configuration Precedence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CONFIGURATION PRECEDENCE                                  â”‚
â”‚                                                                                 â”‚
â”‚   Priority 1 (Highest): ConfigMap mounted files                                 â”‚
â”‚                         /etc/thoughtgate/*.cedar                                â”‚
â”‚                         /etc/thoughtgate/config.yaml (future)                   â”‚
â”‚                                                                                 â”‚
â”‚   Priority 2:           Environment variables                                   â”‚
â”‚                         THOUGHTGATE_*                                           â”‚
â”‚                                                                                 â”‚
â”‚   Priority 3 (Lowest):  Compiled defaults                                       â”‚
â”‚                         (embedded in binary)                                    â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Complete Environment Variable Reference

#### Core Transport (REQ-CORE-003)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_LISTEN` | `0.0.0.0:8080` | Listen address |
| `THOUGHTGATE_UPSTREAM` | (required) | Upstream MCP server URL |
| `THOUGHTGATE_REQUEST_TIMEOUT_SECS` | `30` | Request timeout |
| `THOUGHTGATE_UPSTREAM_CONNECT_TIMEOUT_SECS` | `5` | Upstream connect timeout |
| `THOUGHTGATE_MAX_CONCURRENT_REQUESTS` | `10000` | Max concurrent requests |
| `THOUGHTGATE_KEEPALIVE_SECS` | `60` | Keep-alive timeout |
| `THOUGHTGATE_MAX_REQUEST_BODY_BYTES` | `1048576` | Max request body (1MB) |

#### Streaming (REQ-CORE-001)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_TCP_NODELAY` | `true` | Disable Nagle's algorithm |
| `THOUGHTGATE_TCP_KEEPALIVE_SECS` | `60` | TCP keep-alive |
| `THOUGHTGATE_STREAM_READ_TIMEOUT_SECS` | `300` | Stream read timeout |
| `THOUGHTGATE_STREAM_WRITE_TIMEOUT_SECS` | `300` | Stream write timeout |
| `THOUGHTGATE_STREAM_TOTAL_TIMEOUT_SECS` | `3600` | Total stream timeout |
| `THOUGHTGATE_MAX_CONCURRENT_STREAMS` | `10000` | Max concurrent streams |

#### Buffering (REQ-CORE-002)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_MAX_CONCURRENT_BUFFERS` | `100` | Max concurrent buffered requests |
| `THOUGHTGATE_REQ_BUFFER_MAX` | `2097152` | Max request buffer (2MB) |
| `THOUGHTGATE_RESP_BUFFER_MAX` | `10485760` | Max response buffer (10MB) |
| `THOUGHTGATE_BUFFER_TIMEOUT_SECS` | `30` | Buffer operation timeout |

#### Policy Engine (REQ-POL-001)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_POLICY_FILE` | `/etc/thoughtgate/policies.cedar` | Policy file path |
| `THOUGHTGATE_SCHEMA_FILE` | `/etc/thoughtgate/schema.cedarschema` | Schema file path |
| `THOUGHTGATE_POLICIES` | (none) | Inline policies (Priority 2) |
| `THOUGHTGATE_POLICY_RELOAD_INTERVAL_SECS` | `10` | Hot-reload interval |
| `THOUGHTGATE_DEV_MODE` | `false` | Enable dev mode (permissive) |
| `THOUGHTGATE_DEV_PRINCIPAL` | `dev-app` | Dev mode principal name |
| `THOUGHTGATE_DEV_NAMESPACE` | `development` | Dev mode namespace |

#### Task Management (REQ-GOV-001)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_TASK_DEFAULT_TTL_SECS` | `600` | Default task TTL (10 min) |
| `THOUGHTGATE_TASK_MAX_TTL_SECS` | `86400` | Max task TTL (24 hr) |
| `THOUGHTGATE_TASK_CLEANUP_INTERVAL_SECS` | `60` | Cleanup interval |
| `THOUGHTGATE_TASK_MAX_PENDING_PER_PRINCIPAL` | `10` | Per-principal limit |
| `THOUGHTGATE_TASK_MAX_PENDING_GLOBAL` | `1000` | Global pending limit |
| `THOUGHTGATE_TASK_MIN_POLL_INTERVAL_SECS` | `2` | Min poll interval |
| `THOUGHTGATE_TASK_MAX_POLL_INTERVAL_SECS` | `30` | Max poll interval |

#### Execution Pipeline (REQ-GOV-002)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_APPROVAL_VALIDITY_SECS` | `300` | Approval validity window |
| `THOUGHTGATE_TRANSFORM_DRIFT_MODE` | `strict` | `strict` or `permissive` |
| `THOUGHTGATE_EXECUTION_TIMEOUT_SECS` | `30` | Execution timeout |

#### Approval Integration (REQ-GOV-003)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_APPROVAL_POLL_INTERVAL_SECS` | `5` | Base poll interval |
| `THOUGHTGATE_APPROVAL_POLL_MAX_INTERVAL_SECS` | `30` | Max poll interval (with backoff) |
| `THOUGHTGATE_SLACK_RATE_LIMIT_PER_SEC` | `1` | Slack API rate limit |
| `THOUGHTGATE_MAX_CONCURRENT_POLLS` | `100` | Max concurrent polling tasks |
| `SLACK_BOT_TOKEN` | (required for Slack) | Slack Bot OAuth token |
| `SLACK_CHANNEL` | `#approvals` | Default Slack channel |
| `SLACK_APPROVE_REACTION` | `+1` | Reaction emoji for approval (ğŸ‘) |
| `SLACK_REJECT_REACTION` | `-1` | Reaction emoji for rejection (ğŸ‘) |

#### Operational (REQ-CORE-005)

| Variable | Default | Description |
|----------|---------|-------------|
| `THOUGHTGATE_HEALTH_PORT` | (same as main) | Health endpoint port |
| `THOUGHTGATE_SHUTDOWN_TIMEOUT_SECS` | `30` | Graceful shutdown timeout |
| `THOUGHTGATE_DRAIN_TIMEOUT_SECS` | `25` | Connection drain timeout |
| `THOUGHTGATE_STARTUP_TIMEOUT_SECS` | `15` | Startup timeout |
| `THOUGHTGATE_REQUIRE_UPSTREAM_AT_STARTUP` | `false` | Fail if upstream unreachable |
| `THOUGHTGATE_UPSTREAM_HEALTH_INTERVAL_SECS` | `30` | Upstream health check interval |
| `THOUGHTGATE_LOG_LEVEL` | `info` | Log level (error/warn/info/debug/trace) |
| `THOUGHTGATE_LOG_FORMAT` | `json` | Log format (json/pretty) |

## 7. Scope (v0.1)

### 7.1 In Scope

| Component | Status | Notes |
|-----------|--------|-------|
| **Sidecar Deployment** | Target | K8s pod co-location with agent |
| MCP Transport (JSON-RPC, HTTP+SSE) | Draft | Single upstream |
| Cedar Policy Engine | Draft | 4-way classification |
| Green Path (streaming) | Implemented (Partial) | Zero-copy forwarding works; upgrades/timeouts partial |
| Amber Path (buffering) | Implemented | Full inspector chain support |
| Red Path (errors) | Draft | JSON-RPC error responses |
| Approval Tasks (SEP-1686) | Draft | In-memory storage |
| Execution Pipeline | Draft | Pre/Post-Approval |
| Slack Adapter | Draft | Webhook + interactive |
| Health/Readiness | Draft | K8s probes |
| Graceful Shutdown | Draft | Connection draining |
| Principal from Pod Labels | Draft | K8s downward API for identity |

### 7.2 Out of Scope (v0.1)

| Feature | Notes |
|---------|-------|
| **Gateway Deployment Mode** | Centralized proxy for multiple agents; requires auth |
| **CLI Wrapper** | `thoughtgate wrap -- command` for local dev |
| **Agent Authentication** | API keys, mTLS, JWT for gateway mode |
| Persistent Task Storage | Tasks are in-memory only; lost on restart |
| Unified Observability (OTel) | Per-component metrics only in v0.1 |
| Teams Adapter | Slack only in v0.1 |
| PagerDuty Adapter | Slack only in v0.1 |
| Email Adapter | Slack only in v0.1 |
| A2A Approval Protocol | Agent-to-agent approval not supported |
| Agent Card Support | A2A feature |
| Multi-Upstream Routing | Single upstream MCP server only |
| Web Dashboard | No approval UI; Slack only |
| CRD-based Policy | ConfigMap/env var only |
| Policy Testing Framework | No built-in policy validation tooling |
| Approval Batching | Each approval is individual |
| Audit Log Export | Logs only; no export mechanism |

### 7.3 Known Limitations

| Limitation | Impact | Mitigation |
|------------|--------|------------|
| In-memory task storage | Tasks lost on restart | Clients retry on 404 |
| Single upstream | Can't route to multiple MCP servers | Deploy multiple instances |
| Per-component metrics | No unified tracing | Correlation IDs in logs |
| Slack rate limits | Burst approval requests queue | Outbound rate limiter |

## 8. Deployment Architecture

### 8.1 Deployment Model (v0.1)

**ThoughtGate v0.1 is designed exclusively for sidecar deployment in Kubernetes.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        v0.1 DEPLOYMENT MODEL: SIDECAR                           â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         Kubernetes Pod                                  â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚
â”‚   â”‚   â”‚                 â”‚  localhost â”‚                     â”‚                â”‚  â”‚
â”‚   â”‚   â”‚    AI Agent     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    ThoughtGate     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â–¶ MCP Server
â”‚   â”‚   â”‚   Container     â”‚   :8080    â”‚      Sidecar       â”‚                â”‚  â”‚
â”‚   â”‚   â”‚                 â”‚            â”‚                     â”‚                â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   Identity: Inferred from pod labels / K8s downward API                â”‚  â”‚
â”‚   â”‚   Auth: None required (localhost implicit trust)                        â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Design Rationale:**
| Aspect | Sidecar Advantage |
|--------|-------------------|
| **Latency** | Localhost communication; no network hop |
| **Identity** | Implicit from K8s pod metadata; no auth headers |
| **Isolation** | Per-agent failure domain; no blast radius |
| **Security** | No credentials in agent code |
| **Alignment** | Matches service mesh patterns (Envoy, Istio) |

### 8.2 What's Out of Scope (v0.1)

| Deployment Mode | Status | Notes |
|-----------------|--------|-------|
| **Gateway (centralized)** | âŒ Deferred | Requires agent authentication (API keys, mTLS, JWT) |
| **CLI wrapper** | âŒ Deferred | `thoughtgate wrap -- mcp-server` for local dev |
| **Embedded library** | âŒ Deferred | ThoughtGate as Rust crate |

**Gateway mode** would allow multiple agents to share a single ThoughtGate instance, but requires solving agent authentication - significant additional complexity. This is deferred to a future version based on user demand.

**For local development** in v0.1, use minikube, kind, or Docker Desktop with Kubernetes enabled. This matches the production deployment model and avoids maintaining a separate local-dev code path.

### 8.3 Kubernetes Deployment

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: agent-with-thoughtgate
  labels:
    app: my-agent
    thoughtgate.io/principal: "my-agent"      # Used for identity
    thoughtgate.io/namespace: "production"    # Used for policy scoping
spec:
  containers:
  - name: agent
    image: my-agent:latest
    env:
    - name: MCP_SERVER_URL
      value: "http://localhost:8080"  # Points to sidecar
      
  - name: thoughtgate
    image: thoughtgate:v0.1
    ports:
    - containerPort: 8080
    env:
    - name: THOUGHTGATE_UPSTREAM
      value: "http://mcp-server.mcp-system:3000"
    - name: THOUGHTGATE_CALLBACK_SECRET
      valueFrom:
        secretKeyRef:
          name: thoughtgate-secrets
          key: callback-secret
    - name: SLACK_WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: thoughtgate-secrets
          key: slack-webhook
    volumeMounts:
    - name: policies
      mountPath: /etc/thoughtgate
      readOnly: true
    # Downward API for identity inference
    - name: pod-info
      mountPath: /etc/podinfo
      readOnly: true
      
  volumes:
  - name: policies
    configMap:
      name: thoughtgate-policies
  - name: pod-info
    downwardAPI:
      items:
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels
      - path: "namespace"
        fieldRef:
          fieldPath: metadata.namespace
```

### 8.4 Principal Inference (Sidecar Mode)

In sidecar mode, ThoughtGate infers the Principal from Kubernetes metadata:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRINCIPAL INFERENCE                           â”‚
â”‚                                                                  â”‚
â”‚   Source Priority:                                               â”‚
â”‚   1. Pod label: thoughtgate.io/principal                        â”‚
â”‚   2. Pod label: app.kubernetes.io/name                          â”‚
â”‚   3. Pod label: app                                              â”‚
â”‚   4. Fallback: "unknown"                                         â”‚
â”‚                                                                  â”‚
â”‚   Namespace:                                                     â”‚
â”‚   1. Pod label: thoughtgate.io/namespace                        â”‚
â”‚   2. Actual K8s namespace from downward API                      â”‚
â”‚                                                                  â”‚
â”‚   Result: Principal { namespace: "production", app: "my-agent" }â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This approach:
- Requires zero configuration in the agent
- Uses existing K8s labeling conventions
- Allows policy authors to scope rules by namespace/app
- Provides audit trail attribution automatically

## 9. Security Model

### 9.1 Trust Model (Sidecar)

ThoughtGate v0.1's security model is built around the **sidecar trust assumption**: the agent and ThoughtGate share a pod, so localhost communication is implicitly trusted.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TRUST BOUNDARIES                                      â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        TRUSTED ZONE (Pod)                               â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚   â”‚   â”‚    Agent    â”‚ â—€â”€â”€â”€â”€â”€â–¶ â”‚    ThoughtGate     â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚  Container  â”‚localhostâ”‚      Sidecar       â”‚                      â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚   â”‚                                      â”‚                                  â”‚  â”‚
â”‚   â”‚   Implicit trust: No authentication required                           â”‚  â”‚
â”‚   â”‚   Identity: From pod labels (not from request)                         â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚                                     â”‚
â”‚                           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                      â”‚
â”‚                           NETWORK BOUNDARY (mTLS/NetworkPolicy)                â”‚
â”‚                           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                      â”‚
â”‚                                          â”‚                                     â”‚
â”‚                                          â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                     SEMI-TRUSTED ZONE (Cluster)                         â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚   â”‚   â”‚     MCP Server      â”‚         â”‚       Slack         â”‚              â”‚  â”‚
â”‚   â”‚   â”‚    (Upstream)       â”‚         â”‚   (Webhooks/HMAC)   â”‚              â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why no agent authentication?**
- Agent and ThoughtGate are co-located in the same pod
- Localhost binding prevents external access
- K8s NetworkPolicy can further restrict pod communication
- Identity comes from pod metadata, not request headers
- This matches the Envoy/Istio sidecar trust model

### 9.2 Authentication Summary

| Boundary | Authentication | Notes |
|----------|----------------|-------|
| Agent â†’ ThoughtGate | None (localhost) | Implicit trust in sidecar model |
| ThoughtGate â†’ Upstream | TLS | Optional mTLS for zero-trust clusters |
| ThoughtGate â†’ Slack | Webhook URL | URL acts as bearer token |
| Slack â†’ ThoughtGate | HMAC-SHA256 | Signed callbacks prevent spoofing |
| Human â†’ Slack | Slack auth | Slack handles user identity |
| ThoughtGate â†’ Slack | Webhook URL (secret) |
| Slack â†’ ThoughtGate | HMAC-SHA256 signature |
| Human â†’ Slack | Slack authentication |

## 10. Observability Standards

### 10.1 Correlation ID Strategy

Every request receives a correlation ID that propagates through all components:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CORRELATION ID FLOW                                      â”‚
â”‚                                                                                 â”‚
â”‚   Agent Request                                                                 â”‚
â”‚        â”‚                                                                        â”‚
â”‚        â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ REQ-CORE-003: Generate correlation_id (UUID v4)                         â”‚  â”‚
â”‚   â”‚              Store in McpRequest.correlation_id                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                        â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚        â”‚                                                                 â”‚      â”‚
â”‚        â–¼                                                                 â–¼      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  POL-001    â”‚    â”‚  CORE-001   â”‚    â”‚  CORE-002   â”‚    â”‚   GOV-001     â”‚   â”‚
â”‚   â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚               â”‚   â”‚
â”‚   â”‚ Log with    â”‚    â”‚ Log with    â”‚    â”‚ Log with    â”‚    â”‚ task_id +     â”‚   â”‚
â”‚   â”‚ correlation â”‚    â”‚ correlation â”‚    â”‚ correlation â”‚    â”‚ correlation   â”‚   â”‚
â”‚   â”‚ _id         â”‚    â”‚ _id         â”‚    â”‚ _id         â”‚    â”‚ _id           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ID Hierarchy:**
| ID Type | Scope | Format | Example |
|---------|-------|--------|---------|
| `correlation_id` | Single request | UUID v4 | `550e8400-e29b-41d4-a716-446655440000` |
| `task_id` | Approval task lifetime | UUID v4 | `7c9e6679-7425-40de-944b-e07fc1f90ae7` |
| `request_id` | JSON-RPC ID | String or Integer | `1` or `"req-123"` |

**Log Field Convention:**
```json
{
  "timestamp": "2025-01-08T10:30:00.123Z",
  "level": "info",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "task_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "component": "policy_engine",
  "event": "evaluation_complete",
  "decision": "hitl",
  "duration_ms": 2
}
```

### 10.2 Metric Naming Convention

All metrics follow the pattern: `thoughtgate_<component>_<metric>_<unit>`

**Components:**
| Prefix | Component | Requirement |
|--------|-----------|-------------|
| `thoughtgate_transport_` | MCP Transport | REQ-CORE-003 |
| `thoughtgate_green_` | Green Path | REQ-CORE-001 |
| `thoughtgate_amber_` | Amber Path | REQ-CORE-002 |
| `thoughtgate_policy_` | Policy Engine | REQ-POL-001 |
| `thoughtgate_tasks_` | Task Management | REQ-GOV-001 |
| `thoughtgate_pipeline_` | Execution Pipeline | REQ-GOV-002 |
| `thoughtgate_approval_` | Approval Integration | REQ-GOV-003 |
| `thoughtgate_errors_` | Error Handling | REQ-CORE-004 |
| `thoughtgate_health_` | Operational | REQ-CORE-005 |

**Standard Suffixes:**
| Suffix | Type | Example |
|--------|------|---------|
| `_total` | Counter | `thoughtgate_tasks_created_total` |
| `_active` | Gauge | `thoughtgate_green_streams_active` |
| `_seconds` | Histogram | `thoughtgate_policy_evaluation_seconds` |
| `_bytes` | Histogram | `thoughtgate_amber_buffer_bytes` |

**Golden Metrics (Required for all components):**
```
thoughtgate_requests_total{component, outcome}
thoughtgate_request_duration_seconds{component}
thoughtgate_errors_total{component, type}
```

### 10.3 Logging Standards

**Log Levels:**
| Level | Usage |
|-------|-------|
| `ERROR` | Unrecoverable failures, panics, data corruption |
| `WARN` | Recoverable failures, policy rejections, timeouts |
| `INFO` | Request lifecycle events, state transitions |
| `DEBUG` | Detailed flow information (disabled in production) |
| `TRACE` | Byte-level details (disabled in production) |

**Required Fields:**
Every log entry MUST include:
- `timestamp` (ISO 8601)
- `level`
- `correlation_id` (if in request context)
- `component`
- `event`

**Configuration:**
| Setting | Default | Environment Variable |
|---------|---------|---------------------|
| Log level | `info` | `THOUGHTGATE_LOG_LEVEL` |
| Log format | `json` | `THOUGHTGATE_LOG_FORMAT` |

## 11. Error Code Reference

### 11.1 Consolidated Error Codes

| Code | Name | Description | Source |
|------|------|-------------|--------|
| **JSON-RPC Standard** ||||
| -32700 | Parse error | Invalid JSON | REQ-CORE-003 |
| -32600 | Invalid Request | Invalid JSON-RPC | REQ-CORE-003 |
| -32601 | Method not found | Unknown method | REQ-CORE-004 |
| -32602 | Invalid params | Invalid method params | REQ-CORE-004 |
| -32603 | Internal error | Server error / panic | REQ-CORE-004 |
| **ThoughtGate Custom** ||||
| -32000 | Connection failed | Upstream unreachable | REQ-CORE-004 |
| -32001 | Timeout | Upstream/stream timeout | REQ-CORE-004 |
| -32002 | Upstream error | Upstream returned error | REQ-CORE-004 |
| -32003 | Policy denied | Cedar policy rejection | REQ-POL-001 |
| -32004 | Task not found | Unknown task ID | REQ-GOV-001 |
| -32005 | Task expired | Task TTL exceeded | REQ-GOV-001 |
| -32006 | Task cancelled | Task was cancelled | REQ-GOV-001 (v0.2+) |
| -32007 | Approval rejected | Approver rejected request | REQ-GOV-003 |
| -32008 | Approval timeout | Approval window closed | REQ-GOV-002 |
| -32009 | Rate limited | Too many requests | REQ-GOV-001 |
| -32010 | Inspection failed | Inspector rejected | REQ-CORE-002 |
| -32011 | Policy drift | Policy changed post-approval | REQ-GOV-002 (v0.2+) |
| -32012 | Transform drift | Request changed post-approval | REQ-GOV-002 (v0.2+) |
| -32013 | Service unavailable | Capacity/concurrency limit | REQ-CORE-001/002 |
| -32014 | *Reserved* | Was auto-upgrade (removed as non-SEP-1686-compliant) | N/A |

## 12. Cross-Cutting Concerns

### 12.1 Batch Request Handling with Approval

When a JSON-RPC batch request contains items that require different paths:

```json
// Batch request
[
  {"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"read_file",...}},
  {"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"delete_user",...}},
  {"jsonrpc":"2.0","id":3,"method":"resources/list","params":{}}
]
```

**Policy:** If ANY request in a batch requires Approval, the ENTIRE batch is task-augmented.

**Rationale:** 
- Prevents partial execution that could leave system in inconsistent state
- Human approver sees complete context of what agent is trying to do
- Simplifies client handling (all-or-nothing)

**Response (task-augmented):**
```json
{
  "jsonrpc": "2.0",
  "id": null,
  "result": {
    "taskId": "batch-abc-123",
    "status": "working",
    "itemCount": 3,
    "hitlRequired": [2]
  }
}
```

### 12.2 Approval Handling (v0.1 Blocking Mode)

**âš ï¸ v0.1 uses blocking mode, NOT SEP-1686 auto-upgrade.**

When a client sends a `tools/call` request and the policy requires approval:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     v0.1 BLOCKING APPROVAL FLOW                                 â”‚
â”‚                                                                                 â”‚
â”‚   Agent sends:                                                                  â”‚
â”‚   {                                                                             â”‚
â”‚     "jsonrpc": "2.0",                                                          â”‚
â”‚     "id": 1,                                                                    â”‚
â”‚     "method": "tools/call",                                                     â”‚
â”‚     "params": { "name": "delete_user", "arguments": {...} }                    â”‚
â”‚   }                                                                             â”‚
â”‚                                                                                 â”‚
â”‚   Policy returns: Approval required                                             â”‚
â”‚                                                                                 â”‚
â”‚   ThoughtGate behavior:                                                         â”‚
â”‚   1. Holds HTTP connection open                                                â”‚
â”‚   2. Sends approval request to Slack                                           â”‚
â”‚   3. Waits for human response (with timeout)                                   â”‚
â”‚   4a. On APPROVE: Execute tool, return normal result                           â”‚
â”‚   4b. On REJECT: Return error -32007 (ApprovalRejected)                        â”‚
â”‚   4c. On TIMEOUT: Return error -32008 (ApprovalTimeout)                        â”‚
â”‚                                                                                 â”‚
â”‚   From client perspective: Slow tool call, but standard response               â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why Blocking Mode for v0.1:**
- Works with ANY MCP client (no SEP-1686 support required)
- Simple implementation for MVP
- Predictable behavior for agents

**Limitations:**
- Long approval windows may cause HTTP timeouts
- Client cannot perform other work while waiting
- No visibility into approval status during wait

**v0.2+ will implement SEP-1686 task semantics:**
- Tool annotation rewriting during tools/list
- Task capability declaration during initialize
- Task-augmented response for async-aware clients
- Blocking fallback for legacy clients

See RFC-001 Â§10.1 for full SEP-1686 compliance plan.

### 12.3 Startup Behavior with Unavailable Upstream

| Scenario | Behavior | Readiness |
|----------|----------|-----------|
| Upstream unreachable at startup | Start anyway | NOT Ready |
| Upstream becomes unreachable | Continue serving | Ready (degraded) |
| Upstream returns after outage | Resume normal | Ready |

**Rationale:** 
- Allows pod to start and receive health checks
- Kubernetes can track readiness for traffic routing
- Avoids crash loops during upstream maintenance

**Configuration:**
| Setting | Default | Environment Variable |
|---------|---------|---------------------|
| Require upstream at startup | `false` | `THOUGHTGATE_REQUIRE_UPSTREAM_AT_STARTUP` |
| Upstream health check interval | `30s` | `THOUGHTGATE_UPSTREAM_HEALTH_INTERVAL_SECS` |

### 12.4 Inspector Registration

Inspectors are registered at compile time for v0.1:

```rust
// In main.rs or lib.rs
fn build_inspector_chain() -> Vec<Arc<dyn Inspector>> {
    vec![
        Arc::new(PiiDetector::new()),
        Arc::new(SchemaValidator::new()),
        // Add custom inspectors here
    ]
}
```

**Registration Order:** Inspectors execute in registration order. Place fast validators before slow transformers.

**Future:** Plugin system for dynamic inspector loading (out of scope for v0.1).

### 12.5 Task Polling Interval

The `poll_interval` in task responses is computed dynamically:

```rust
fn compute_poll_interval(ttl: Duration) -> Duration {
    // Poll more frequently as expiration approaches
    let remaining = ttl.as_secs();
    match remaining {
        0..=60 => Duration::from_secs(2),      // Last minute: 2s
        61..=300 => Duration::from_secs(5),    // Last 5 min: 5s
        301..=900 => Duration::from_secs(10),  // Last 15 min: 10s
        _ => Duration::from_secs(30),          // Otherwise: 30s
    }
}
```

**Configuration:**
| Setting | Default | Environment Variable |
|---------|---------|---------------------|
| Min poll interval | `2s` | `THOUGHTGATE_TASK_MIN_POLL_INTERVAL_SECS` |
| Max poll interval | `30s` | `THOUGHTGATE_TASK_MAX_POLL_INTERVAL_SECS` |

### 12.6 Principal Serialization

Principals are serialized for logging and metrics as: `{namespace}/{app_name}`

**Examples:**
- `production/payment-agent`
- `staging/data-pipeline`
- `development/dev-app` (dev mode)

**In Logs:**
```json
{
  "principal": "production/payment-agent",
  "principal_namespace": "production",
  "principal_app": "payment-agent"
}
```

**In Metrics:**
```
thoughtgate_tasks_created_total{principal="production/payment-agent"}
```

## 13. Glossary

| Term | Definition |
|------|------------|
| **MCP** | Model Context Protocol - standard for AI agent tool communication |
| **SEP-1686** | MCP enhancement proposal for task-based async execution |
| **Approval** | Approval-based - requiring human approval before execution |
| **Cedar** | Policy language by AWS for fine-grained authorization |
| **Principal** | Entity making a request (identified by K8s namespace + app name) |
| **Green Path** | Zero-copy streaming for trusted traffic (REQ-CORE-001) |
| **Amber Path** | Buffered inspection for traffic requiring validation (REQ-CORE-002) |
| **Red Path** | Immediate rejection for denied traffic (REQ-CORE-004) |
| **Approval Path** | Human approval workflow (REQ-GOV-001/002/003) |
| **Task** | SEP-1686 entity tracking async request through approval workflow |
| **Inspector** | Component that examines and optionally transforms request bodies |
| **Sidecar** | Deployment pattern where ThoughtGate runs alongside agent in same pod |
| **Upstream** | The MCP server that ThoughtGate proxies requests to |
| **Transform Drift** | Request body changed between approval and execution |
| **Policy Drift** | Cedar policy changed between approval and execution |

## 14. Quick Reference

### 14.1 Endpoints

| Endpoint | Port | Purpose |
|----------|------|---------|
| `POST /mcp/v1` | 8080 | MCP JSON-RPC |
| `GET /health` | 8080 | Liveness probe |
| `GET /ready` | 8080 | Readiness probe |
| `GET /metrics` | 8080 | Prometheus metrics |

**Note:** No inbound callback endpoints required - approval uses outbound polling model.

### 14.2 Environment Variables (Quick List)

**Required:**
```
THOUGHTGATE_UPSTREAM=http://mcp-server:3000
SLACK_BOT_TOKEN=xoxb-your-bot-token
```

**Common Overrides:**
```
THOUGHTGATE_LISTEN=0.0.0.0:8080
THOUGHTGATE_LOG_LEVEL=info
THOUGHTGATE_POLICY_FILE=/etc/thoughtgate/policies.cedar
THOUGHTGATE_TASK_DEFAULT_TTL_SECS=600
THOUGHTGATE_TRANSFORM_DRIFT_MODE=strict
SLACK_CHANNEL=#approvals
```

### 14.3 Decision Flow (Quick Reference)

```
Request â†’ Parse JSON-RPC â†’ Route by Method
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
            â–¼                 â–¼                 â–¼
       tools/call        tasks/*           other
            â”‚                 â”‚                 â”‚
            â–¼                 â–¼                 â–¼
       Cedar Policy     Task Handler      Pass Through
            â”‚                                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚       â”‚       â”‚           â”‚              â”‚
    â–¼       â–¼       â–¼           â–¼              â”‚
  Green   Amber   Approval        Red              â”‚
    â”‚       â”‚       â”‚           â”‚              â”‚
    â”‚       â”‚       â–¼           â–¼              â”‚
    â”‚       â”‚    Create      Error             â”‚
    â”‚       â”‚    Task        Response          â”‚
    â”‚       â”‚       â”‚                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
                Upstream
```

## 15. References

| Resource | Link |
|----------|------|
| SEP-1686 (Tasks) | https://github.com/modelcontextprotocol/modelcontextprotocol/issues/1686 |
| Model Context Protocol | https://modelcontextprotocol.io/ |
| Cedar Policy Language | https://www.cedarpolicy.com/ |
| JSON-RPC 2.0 | https://www.jsonrpc.org/specification |

## 16. Requirement Index

| ID | Title | Status | Type |
|----|-------|--------|------|
| REQ-CORE-001 | Zero-Copy Streaming (Green Path) | Implemented (Partial) | Core |
| REQ-CORE-002 | Buffered Inspection (Amber Path) | Implemented | Core |
| REQ-CORE-003 | MCP Transport & Routing | Draft | Core |
| REQ-CORE-004 | Error Handling | Draft | Core |
| REQ-CORE-005 | Operational Lifecycle | Draft | Core |
| REQ-POL-001 | Cedar Policy Engine | Draft | Policy |
| REQ-GOV-001 | Task Lifecycle & SEP-1686 | Draft | Governance |
| REQ-GOV-002 | Approval Execution Pipeline | Draft | Governance |
| REQ-GOV-003 | Approval Integration | Draft | Governance |